services:
    keycloak:
        image: quay.io/keycloak/keycloak:latest
        container_name: keycloak
        ports:
            - '8180:8080'
        environment:
            KC_BOOTSTRAP_ADMIN_USERNAME: admin
            KC_BOOTSTRAP_ADMIN_PASSWORD: admin
            KC_HTTP_ENABLED: "true"
            KC_HOSTNAME_STRICT: "false"
        entrypoint: ["/bin/bash", "-c"]
        command: >
            "/opt/keycloak/bin/kc.sh start-dev --import-realm &
             KC_PID=$$!
             echo 'Waiting for Keycloak to be ready...'
             until curl -sf http://localhost:8080/health/ready > /dev/null 2>&1; do sleep 3; done
             echo 'Disabling SSL on master realm...'
             /opt/keycloak/bin/kcadm.sh config credentials --server http://localhost:8080 --realm master --user admin --password admin
             /opt/keycloak/bin/kcadm.sh update realms/master -s sslRequired=none
             echo 'SSL disabled on master realm.'
             wait $$KC_PID"
        volumes:
            - ./_resources/_keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json
        networks:
            - microservices-network

#     mongodb:
#         image: mongo:latest
#         container_name: mongodb
#         restart: always
#         ports:
#             - '27017:27017'
#         environment:
#             MONGO_INITDB_ROOT_USERNAME: admin
#             MONGO_INITDB_ROOT_PASSWORD: password
#         volumes:
#             - mongodb_data:/data/db
# volumes:
#     mongodb_data:
#         driver: local

networks:
    microservices-network:
        name: microservices-network
        driver: bridge

# ==========================================================
# Step 1: run provider first
# => docker compose -f .\docker-compose-provider.yml up -d
#
# Step 2: set KEYCLOAK_CLIENT_SECRET in user-service/.env
# => then run main app
# => docker compose up -d
# ==========================================================
